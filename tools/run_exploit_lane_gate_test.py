"""
Exploit Lane Gate Test Tool (Phase 4l)
---------------------------------------

CLI tool to test and visualize exploit lane gate decisions.

Loads current reports and prints a table showing which symbols would be blocked
and why.
"""

from __future__ import annotations

import sys
from pathlib import Path

# Add parent directory to path for imports
ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))

from engine_alpha.risk.exploit_lane_gate import apply_exploit_lane_gate


def main() -> int:
    """Main entry point."""
    print("EXPLOIT LANE GATE TEST (Phase 4l)")
    print("=" * 80)
    print()
    
    # Load capital plan to get all symbols
    from engine_alpha.core.paths import REPORTS
    import json
    
    CAPITAL_PLAN_PATH = REPORTS / "risk" / "capital_plan.json"
    
    if not CAPITAL_PLAN_PATH.exists():
        print("ERROR: capital_plan.json not found. Run policy_refresh first.")
        return 1
    
    try:
        with CAPITAL_PLAN_PATH.open("r", encoding="utf-8") as f:
            capital_plan = json.load(f)
    except Exception as e:
        print(f"ERROR: Failed to load capital_plan.json: {e}")
        return 1
    
    symbols_plan = capital_plan.get("symbols", {})
    if not symbols_plan:
        print("No symbols in capital plan.")
        return 0
    
    # Test each symbol
    results = []
    for symbol in sorted(symbols_plan.keys()):
        can_open, decision = apply_exploit_lane_gate(
            symbol=symbol,
            can_open=True,
            is_paper=True,
            is_exploration=False,
        )
        
        entry = symbols_plan.get(symbol, {})
        weight = entry.get("weight", 0.0)
        lane_intent = entry.get("lane_intent", "—")
        
        # Load additional data for display
        from engine_alpha.risk.exploit_lane_gate import _load_json
        from engine_alpha.risk.exploit_lane_gate import CAPITAL_PROTECTION_PATH, LIVE_CANDIDATES_PATH, POLICY_PATH
        
        capital_protection = _load_json(CAPITAL_PROTECTION_PATH)
        live_candidates = _load_json(LIVE_CANDIDATES_PATH)
        policy = _load_json(POLICY_PATH)
        
        global_mode = capital_protection.get("global", {})
        mode = global_mode.get("mode", "—")
        
        symbols_lc = live_candidates.get("symbols", {})
        symbol_lc = symbols_lc.get(symbol, {})
        ready_now_raw = symbol_lc.get("ready_now") or symbol_lc.get("ReadyNow") or symbol_lc.get("ready")
        
        # Normalize ready_now using gate helper
        from engine_alpha.risk.exploit_lane_gate import is_ready_now
        ready_now = "Y" if is_ready_now(ready_now_raw) else "N"
        
        symbols_policy = policy.get("symbols", {})
        symbol_policy = symbols_policy.get(symbol, {})
        policy_level = symbol_policy.get("level", "—")
        
        decision_str = "ALLOW" if can_open else "BLOCK"
        reason = decision.reason if decision and decision.reason else "—"
        
        results.append({
            "symbol": symbol,
            "weight": weight,
            "lane_intent": lane_intent,
            "mode": mode,
            "policy": policy_level,
            "ready_now": str(ready_now) if ready_now != "—" else "—",
            "decision": decision_str,
            "reason": reason,
        })
    
    # Print table
    print(f"{'Symbol':<12} {'Weight':<8} {'Intent':<8} {'Mode':<18} {'Policy':<10} {'ReadyNow':<10} {'Decision':<8} {'Reason'}")
    print("-" * 120)
    
    for r in results:
        print(
            f"{r['symbol']:<12} {r['weight']:<8.3f} {r['lane_intent']:<8} {r['mode']:<18} "
            f"{r['policy']:<10} {r['ready_now']:<10} {r['decision']:<8} {r['reason']}"
        )
    
    print()
    print("=" * 80)
    print(f"Total symbols: {len(results)}")
    blocked_count = sum(1 for r in results if r['decision'] == 'BLOCK')
    allowed_count = len(results) - blocked_count
    print(f"Blocked: {blocked_count}, Allowed: {allowed_count}")
    print()
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
