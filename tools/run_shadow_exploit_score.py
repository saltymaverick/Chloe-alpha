"""
Shadow Exploit Score CLI (Phase 5b)
------------------------------------

Runs shadow exploit scorer and prints summary.
"""

from __future__ import annotations

import sys
from engine_alpha.reflect.shadow_exploit_scorer import compute_shadow_scores


def main() -> int:
    """Main entry point."""
    print("SHADOW EXPLOIT SCORER (Phase 5b)")
    print("=" * 80)
    print()
    
    try:
        scores = compute_shadow_scores()
        
        # Global summary
        global_metrics = scores.get("global", {})
        print("GLOBAL METRICS")
        print("-" * 80)
        print(f"Trades: {global_metrics.get('trades', 0)}")
        print(f"Win Rate: {global_metrics.get('win_rate', 0.0):.1%}")
        print(f"PF 1D: {global_metrics.get('pf_1d', 0) or '—':>6}")
        print(f"PF 7D: {global_metrics.get('pf_7d', 0) or '—':>6}")
        print(f"PF 30D: {global_metrics.get('pf_30d', 0) or '—':>6}")
        print(f"Max DD: {global_metrics.get('max_drawdown_pct', 0.0):.2f}%")
        print(f"Expectancy: {global_metrics.get('expectancy_pct', 0.0):.3f}%")
        print()
        
        # Top symbols by PF_30D
        by_symbol = scores.get("by_symbol", {})
        if by_symbol:
            print("TOP SYMBOLS BY PF_30D")
            print("-" * 80)
            print(f"{'Symbol':<10} {'PF_30D':>8} {'Trades':>8} {'Win%':>6} {'MDD%':>6} {'Exp%':>7}")
            print("-" * 80)
            
            sorted_symbols = sorted(
                by_symbol.items(),
                key=lambda x: x[1].get("pf_30d") or 0.0,
                reverse=True,
            )[:10]
            
            for symbol, data in sorted_symbols:
                pf_30d = data.get("pf_30d")
                trades = data.get("trades", 0)
                win_rate = data.get("win_rate", 0.0)
                mdd = data.get("max_drawdown_pct", 0.0)
                expectancy = data.get("expectancy_pct", 0.0)
                
                # Phase 5H.2 Cleanup: Show "—" when PF is None OR trades=0
                if pf_30d is None or trades == 0:
                    pf_str = "—"
                else:
                    pf_str = f"{pf_30d:.2f}"
                print(
                    f"{symbol:<10} {pf_str:>8} {trades:>8} "
                    f"{win_rate*100:>5.1f}% {mdd:>5.2f}% {expectancy:>6.3f}%"
                )
            print()
            
            # Top by expectancy
            print("TOP SYMBOLS BY EXPECTANCY")
            print("-" * 80)
            print(f"{'Symbol':<10} {'Exp%':>7} {'PF_30D':>8} {'Trades':>8} {'Win%':>6}")
            print("-" * 80)
            
            sorted_by_exp = sorted(
                by_symbol.items(),
                key=lambda x: x[1].get("expectancy_pct", 0.0),
                reverse=True,
            )[:10]
            
            for symbol, data in sorted_by_exp:
                expectancy = data.get("expectancy_pct", 0.0)
                pf_30d = data.get("pf_30d")
                trades = data.get("trades", 0)
                win_rate = data.get("win_rate", 0.0)
                
                # Phase 5H.2 Cleanup: Show "—" when PF is None OR trades=0
                if pf_30d is None or trades == 0:
                    pf_str = "—"
                else:
                    pf_str = f"{pf_30d:.2f}"
                print(
                    f"{symbol:<10} {expectancy:>6.3f}% {pf_str:>8} "
                    f"{trades:>8} {win_rate*100:>5.1f}%"
                )
            print()
        
        # Data health
        health = scores.get("data_health", {})
        print("DATA HEALTH")
        print("-" * 80)
        print(f"Log found: {health.get('log_found', False)}")
        print(f"Total events: {health.get('events', 0)}")
        print(f"Exit events: {health.get('exits', 0)}")
        print()
        
        # Notes
        notes = scores.get("notes", [])
        if notes:
            print("NOTES")
            print("-" * 80)
            for note in notes:
                print(f"  • {note}")
            print()
        
        print("=" * 80)
        print(f"Scores written to: reports/reflect/shadow_exploit_scores.json")
        print(f"PF snapshot written to: reports/reflect/shadow_exploit_pf.json")
        
        return 0
    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())

