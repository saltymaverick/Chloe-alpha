"""
Exploit Micro Lane CLI (Phase 5c)
----------------------------------

Runs exploit micro lane evaluation once and prints result.
"""

from __future__ import annotations

import sys
from engine_alpha.loop.exploit_micro_lane import run_once, _load_state, _load_json
from engine_alpha.core.paths import REPORTS
from pathlib import Path


def main() -> int:
    """Main entry point."""
    print("EXPLOIT MICRO LANE (Phase 5c)")
    print("=" * 80)
    print()
    
    # Check if PAPER mode
    import os
    is_paper = os.getenv("MODE", "PAPER").upper() == "PAPER"
    if not is_paper:
        print("ERROR: Exploit micro lane is PAPER-only.")
        print(f"Current mode: {os.getenv('MODE', 'unknown')}")
        return 1
    
    # Load state
    state = _load_state()
    capital_protection = _load_json(REPORTS / "risk" / "capital_protection.json")
    
    # Extract capital mode (handle different structures)
    capital_mode = capital_protection.get("mode")
    if not capital_mode:
        global_data = capital_protection.get("global", {})
        capital_mode = global_data.get("mode", "unknown")
    
    print(f"Capital Mode: {capital_mode}")
    print()
    
    # Check current state
    if state.get("open_position"):
        symbol = state.get("symbol", "unknown")
        entry_ts = state.get("entry_ts", "unknown")
        notional = state.get("notional", 0.0)
        print(f"Current Position: {symbol} (opened: {entry_ts}, notional: ${notional:.2f})")
    else:
        print("Current Position: None")
    
    cooldown_until = state.get("cooldown_until")
    if cooldown_until:
        print(f"Cooldown Until: {cooldown_until}")
    else:
        print("Cooldown: None")
    print()
    
    # Run evaluation
    print("Running evaluation...")
    print("-" * 80)
    result = run_once(reason="manual")
    
    action = result.get("action", "unknown")
    reason = result.get("reason", "")
    symbol = result.get("symbol", "")
    
    print(f"Action: {action}")
    if reason:
        print(f"Reason: {reason}")
    if symbol:
        print(f"Symbol: {symbol}")
    if result.get("direction"):
        print(f"Direction: {'LONG' if result['direction'] == 1 else 'SHORT'}")
    if result.get("confidence"):
        print(f"Confidence: {result['confidence']:.2f}")
    if result.get("notional"):
        print(f"Notional: ${result['notional']:.2f}")
    print()
    
    # Show last log entries
    log_path = REPORTS / "loop" / "exploit_micro_log.jsonl"
    if log_path.exists():
        print("Last 10 Events:")
        print("-" * 80)
        try:
            with log_path.open("r", encoding="utf-8") as f:
                lines = f.readlines()
                for line in lines[-10:]:
                    import json
                    try:
                        event = json.loads(line.strip())
                        ts = event.get("ts", "")[:19]
                        sym = event.get("symbol", "")
                        act = event.get("action", "")
                        rsn = event.get("reason", "")[:40]
                        print(f"{ts} {sym:<10} {act:<10} {rsn}")
                    except Exception:
                        pass
        except Exception:
            pass
        print()
    
    print("=" * 80)
    print(f"Log: {log_path}")
    print(f"State: {REPORTS / 'loop' / 'exploit_micro_state.json'}")
    
    return 0 if action in ("opened", "blocked", "skipped") else 1


if __name__ == "__main__":
    sys.exit(main())

