"""
Shadow Exploit Lane CLI Tool (Phase 5a)
----------------------------------------

CLI tool to run shadow exploit lane evaluation and display results.
"""

from __future__ import annotations

import json
import sys
from pathlib import Path
from datetime import datetime, timezone

# Add parent directory to path
ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))

from engine_alpha.core.paths import REPORTS
from engine_alpha.reflect.shadow_exploit_lane import (
    _load_json,
    _load_shadow_state,
    evaluate_all_eligible_symbols,
    LOG_PATH,
    PF_PATH,
    CAPITAL_PLAN_PATH,
)


def main() -> int:
    """Main entry point."""
    print("SHADOW EXPLOIT LANE (Phase 5a)")
    print("=" * 80)
    print()
    
    # Run evaluation for all eligible symbols
    print("Evaluating all eligible symbols...")
    evaluate_all_eligible_symbols()
    print("Evaluation complete.")
    print()
    
    # Load capital plan to get eligible symbols
    capital_plan = _load_json(CAPITAL_PLAN_PATH)
    symbols_plan = capital_plan.get("symbols", {})
    
    # Find exploit-intent symbols
    exploit_symbols = []
    for sym, entry in symbols_plan.items():
        lane_intent = entry.get("lane_intent")
        if lane_intent == "exploit":
            exploit_symbols.append((sym, entry.get("weight", 0.0)))
    
    exploit_symbols.sort(key=lambda x: x[1], reverse=True)
    
    print(f"Eligible Symbols: {len(exploit_symbols)}")
    print("-" * 80)
    for sym, weight in exploit_symbols[:10]:
        print(f"  {sym:<12} weight={weight:.3f}")
    if len(exploit_symbols) > 10:
        print(f"  ... and {len(exploit_symbols) - 10} more")
    print()
    
    # Load shadow state
    positions = _load_shadow_state()
    print(f"Open Shadow Positions: {len(positions)}")
    print("-" * 80)
    if positions:
        for sym, pos in positions.items():
            dir_str = "LONG" if pos.direction == 1 else "SHORT"
            print(f"  {sym:<12} {dir_str:<5} entry={pos.entry_price:.4f} bars={pos.bars_open}")
    else:
        print("  (none)")
    print()
    
    # Load last events
    if LOG_PATH.exists():
        events = []
        try:
            with LOG_PATH.open("r", encoding="utf-8") as f:
                lines = f.readlines()
                for line in lines[-20:]:
                    try:
                        events.append(json.loads(line.strip()))
                    except Exception:
                        continue
        except Exception:
            pass
        
        print(f"Last 20 Events:")
        print("-" * 80)
        print(f"{'Time':<20} {'Symbol':<12} {'Action':<12} {'Reason':<30}")
        print("-" * 80)
        for event in events[-20:]:
            ts = event.get("ts", "")[:19] if event.get("ts") else ""
            sym = event.get("symbol", "")
            action = event.get("action", "")
            reason = event.get("reason", "")[:28]
            print(f"{ts:<20} {sym:<12} {action:<12} {reason:<30}")
    else:
        print("No events logged yet.")
    print()
    
    # Load PF snapshot
    pf_data = _load_json(PF_PATH)
    if pf_data:
        print("Shadow PF Snapshot:")
        print("-" * 80)
        pf_1d = pf_data.get("pf_1d")
        pf_7d = pf_data.get("pf_7d")
        pf_30d = pf_data.get("pf_30d")
        trades_1d = pf_data.get("trades_1d", 0)
        trades_7d = pf_data.get("trades_7d", 0)
        trades_30d = pf_data.get("trades_30d", 0)
        
        pf_1d_str = f"{pf_1d:.4f}" if pf_1d is not None else "—"
        pf_7d_str = f"{pf_7d:.4f}" if pf_7d is not None else "—"
        pf_30d_str = f"{pf_30d:.4f}" if pf_30d is not None else "—"
        
        print(f"  PF_1D:  {pf_1d_str:<10} (trades: {trades_1d})")
        print(f"  PF_7D:  {pf_7d_str:<10} (trades: {trades_7d})")
        print(f"  PF_30D: {pf_30d_str:<10} (trades: {trades_30d})")
        print()
        print(f"Log: {LOG_PATH}")
        print(f"State: {REPORTS / 'reflect' / 'shadow_exploit_state.json'}")
        print(f"PF: {PF_PATH}")
    else:
        print("No PF snapshot available yet.")
    
    print()
    print("=" * 80)
    return 0


if __name__ == "__main__":
    sys.exit(main())

