"""
Exploit Lane Runner CLI Tool (Phase 5c)
---------------------------------------

CLI tool to run exploit lane evaluation and place micro-paper trades.
"""

from __future__ import annotations

import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))

from engine_alpha.loop.exploit_lane_runner import run_exploit_lane
from engine_alpha.loop.exploit_executor_paper import get_open_positions
import os


def main() -> int:
    """Main entry point."""
    print("EXPLOIT LANE RUNNER (Phase 5c)")
    print("=" * 80)
    print()
    
    # Load arming state (Phase 5d)
    from engine_alpha.core.paths import REPORTS
    import json
    arming_path = REPORTS / "loop" / "exploit_arming.json"
    arming_state = {}
    if arming_path.exists():
        try:
            with arming_path.open("r", encoding="utf-8") as f:
                arming_state = json.load(f)
        except Exception:
            pass
    
    # Run exploit lane
    result = run_exploit_lane()
    
    enabled = result.get("enabled", False)
    armed = result.get("armed", False)
    reason = result.get("reason", "unknown")
    capital_mode = result.get("capital_mode", arming_state.get("capital_mode", "unknown"))
    
    print(f"Enabled: {enabled}")
    if not enabled:
        print(f"Reason: {reason}")
        if not armed:
            print("(Check exploit_arming.json for arming status)")
    print(f"Capital Mode: {capital_mode}")
    print()
    
    # Show open positions
    open_positions = get_open_positions()
    print(f"Open Positions: {len(open_positions)}")
    print("-" * 80)
    if open_positions:
        for sym, pos in open_positions.items():
            dir_str = "LONG" if pos.direction == 1 else "SHORT"
            print(f"  {sym:<12} {dir_str:<5} entry={pos.entry_price:.4f} notional=${pos.notional_usd:.2f}")
    else:
        print("  (none)")
    print()
    
    # Show actions
    actions = result.get("actions", [])
    print(f"Actions: {len(actions)}")
    print("-" * 80)
    for action in actions:
        action_type = action.get("action", "")
        symbol = action.get("symbol", "")
        if action_type == "opened":
            print(f"  ✓ Opened {symbol} (notional=${action.get('notional_usd', 0):.2f})")
        elif action_type == "closed":
            pnl = action.get("pnl_usd", 0)
            pnl_str = f"+${pnl:.2f}" if pnl >= 0 else f"${pnl:.2f}"
            print(f"  ✓ Closed {symbol} ({pnl_str})")
        elif action_type == "blocked":
            reason = action.get("reason", "")
            print(f"  ✗ Blocked {symbol}: {reason}")
    
    if not actions:
        print("  (no actions)")
    print()
    
    print("=" * 80)
    return 0


if __name__ == "__main__":
    sys.exit(main())

