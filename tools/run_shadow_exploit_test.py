"""
Shadow Exploit Lane Safety Test (Phase 5a)
------------------------------------------

Verifies that shadow_exploit_lane module:
  - Does NOT import executor modules
  - Does NOT call execute_trade()
  - Only produces logs, no orders
"""

from __future__ import annotations

import ast
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
SHADOW_MODULE_PATH = ROOT / "engine_alpha" / "reflect" / "shadow_exploit_lane.py"


def check_imports() -> bool:
    """Check that shadow module doesn't import executor."""
    if not SHADOW_MODULE_PATH.exists():
        print(f"ERROR: {SHADOW_MODULE_PATH} not found")
        return False
    
    try:
        source = SHADOW_MODULE_PATH.read_text()
        tree = ast.parse(source)
        
        forbidden_imports = [
            "execute_trade",
            "executor",
            "order",
            "submit",
            "place_order",
        ]
        
        for node in ast.walk(tree):
            if isinstance(node, ast.Import):
                for alias in node.names:
                    if any(forbidden in alias.name.lower() for forbidden in forbidden_imports):
                        print(f"ERROR: Forbidden import found: {alias.name}")
                        return False
            elif isinstance(node, ast.ImportFrom):
                if node.module and any(forbidden in node.module.lower() for forbidden in forbidden_imports):
                    print(f"ERROR: Forbidden import from: {node.module}")
                    return False
        
        print("✓ No forbidden imports found")
        return True
    except Exception as e:
        print(f"ERROR: Failed to parse module: {e}")
        return False


def check_function_calls() -> bool:
    """Check that shadow module doesn't call execute_trade."""
    if not SHADOW_MODULE_PATH.exists():
        return False
    
    try:
        source = SHADOW_MODULE_PATH.read_text()
        tree = ast.parse(source)
        
        forbidden_calls = [
            "execute_trade",
            "submit_order",
            "place_order",
        ]
        
        for node in ast.walk(tree):
            if isinstance(node, ast.Call):
                if isinstance(node.func, ast.Name):
                    if node.func.id.lower() in [f.lower() for f in forbidden_calls]:
                        print(f"ERROR: Forbidden function call found: {node.func.id}")
                        return False
                elif isinstance(node.func, ast.Attribute):
                    if node.func.attr.lower() in [f.lower() for f in forbidden_calls]:
                        print(f"ERROR: Forbidden method call found: {node.func.attr}")
                        return False
        
        print("✓ No forbidden function calls found")
        return True
    except Exception as e:
        print(f"ERROR: Failed to check function calls: {e}")
        return False


def main() -> int:
    """Run safety tests."""
    print("SHADOW EXPLOIT LANE SAFETY TEST (Phase 5a)")
    print("=" * 80)
    print()
    
    checks_passed = True
    
    print("1. Checking imports...")
    if not check_imports():
        checks_passed = False
    print()
    
    print("2. Checking function calls...")
    if not check_function_calls():
        checks_passed = False
    print()
    
    if checks_passed:
        print("=" * 80)
        print("✓ All safety checks passed")
        print("Shadow exploit lane is safe (no order placement)")
        return 0
    else:
        print("=" * 80)
        print("✗ Safety checks failed")
        print("Shadow exploit lane may have order placement code")
        return 1


if __name__ == "__main__":
    sys.exit(main())

