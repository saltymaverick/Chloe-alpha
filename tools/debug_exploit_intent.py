"""
Debug Exploit Intent
--------------------

Shows exploit intent (direction, confidence) for each eligible symbol.
Helps diagnose why shadow/micro exploit lanes see 0/0 signals.
"""

from __future__ import annotations

import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))

from engine_alpha.loop.exploit_intent import compute_exploit_intent
from engine_alpha.core.paths import REPORTS
import json


def _load_json(path: Path) -> dict:
    """Load JSON file."""
    if not path.exists():
        return {}
    try:
        with path.open("r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {}


def main() -> int:
    """Main entry point."""
    print("EXPLOIT INTENT DEBUG")
    print("=" * 80)
    print()
    
    # Load eligible symbols from capital plan
    capital_plan = _load_json(REPORTS / "risk" / "capital_plan.json")
    
    # Handle different capital_plan structures
    by_symbol = capital_plan.get("by_symbol", {})
    if not by_symbol:
        # Try symbols key
        by_symbol = capital_plan.get("symbols", {})
    
    if not by_symbol:
        print("No symbols in capital plan. Run policy_refresh first.")
        print(f"Capital plan keys: {list(capital_plan.keys())}")
        return 1
    
    # Filter to exploit-intent symbols
    exploit_symbols = []
    for sym, data in by_symbol.items():
        if isinstance(data, dict):
            lane_intent = data.get("lane_intent", "")
            if lane_intent == "exploit":
                exploit_symbols.append(sym)
    
    if not exploit_symbols:
        print("No exploit-intent symbols found.")
        return 1
    
    print(f"Found {len(exploit_symbols)} exploit-intent symbols")
    print()
    print(f"{'Symbol':<12} {'Dir':<4} {'Conf':<6} {'Entry':<6} {'Exit':<6} {'Regime':<12} {'Reason'}")
    print("-" * 80)
    
    for symbol in sorted(exploit_symbols):
        try:
            intent = compute_exploit_intent(symbol=symbol, timeframe="15m")
            
            direction = intent.get("direction", 0)
            confidence = intent.get("confidence", 0.0)
            entry_ok = intent.get("entry_ok", False)
            exit_ok = intent.get("exit_ok", False)
            regime = intent.get("regime", "unknown")
            reason = intent.get("reason", "")
            
            dir_str = f"{direction:+d}" if direction != 0 else "0"
            conf_str = f"{confidence:.3f}" if confidence > 0 else "0.000"
            entry_str = "Y" if entry_ok else "N"
            exit_str = "Y" if exit_ok else "N"
            
            print(f"{symbol:<12} {dir_str:<4} {conf_str:<6} {entry_str:<6} {exit_str:<6} {regime:<12} {reason}")
        except Exception as e:
            print(f"{symbol:<12} ERROR: {str(e)}")
    
    print()
    print("=" * 80)
    print()
    print("Interpretation:")
    print("  • Dir: -1=SHORT, 0=FLAT, +1=LONG")
    print("  • Conf: Confidence score [0.0, 1.0]")
    print("  • Entry: Y if direction != 0 AND confidence >= 0.50")
    print("  • Exit: Y if confidence < 0.42")
    print()
    print("If all symbols show Dir=0, Conf=0.000:")
    print("  • Check signal_processor is working")
    print("  • Check OHLCV data is available")
    print("  • Check symbol registry is correct")
    
    return 0


if __name__ == "__main__":
    sys.exit(main())

