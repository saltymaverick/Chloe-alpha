"""
Micro-Paper Exploit Safety Test
--------------------------------

Verifies that micro-paper exploit components are safe:
- No LIVE exchange client imports
- PAPER-only guard enforced
- ENABLE flag required
- Logs are created correctly
"""

from __future__ import annotations

import ast
import importlib
import sys
from pathlib import Path
from typing import Set, List

ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))


FORBIDDEN_IMPORTS = {
    "engine_alpha.loop.execute_trade",
    "engine_alpha.loop.live_bridge",
    "engine_alpha.exchange",
    "engine_alpha.executor",
}


def check_imports(module_path: Path) -> List[str]:
    """Check for forbidden imports in a Python file."""
    violations = []
    
    try:
        with module_path.open("r", encoding="utf-8") as f:
            source = f.read()
        
        tree = ast.parse(source, filename=str(module_path))
        
        for node in ast.walk(tree):
            if isinstance(node, ast.Import):
                for alias in node.names:
                    if alias.name in FORBIDDEN_IMPORTS:
                        violations.append(f"Import: {alias.name}")
            elif isinstance(node, ast.ImportFrom):
                if node.module and node.module in FORBIDDEN_IMPORTS:
                    violations.append(f"ImportFrom: {node.module}")
    except Exception as e:
        violations.append(f"Parse error: {e}")
    
    return violations


def check_paper_guard(module_path: Path) -> bool:
    """Check if module has PAPER-only guard."""
    try:
        with module_path.open("r", encoding="utf-8") as f:
            content = f.read()
        
        # Look for PAPER mode checks
        checks = [
            'MODE == "PAPER"',
            'MODE != "PAPER"',
            'mode == "PAPER"',
            'mode != "PAPER"',
            'IS_PAPER_MODE',
            'PAPER_MODE',
            '_ensure_paper_mode',
        ]
        
        return any(check in content for check in checks)
    except Exception:
        return False


def main() -> int:
    """Main entry point."""
    print("MICRO-PAPER EXPLOIT SAFETY TEST")
    print("=" * 80)
    print()
    
    errors = []
    warnings = []
    
    # Check exploit executor
    executor_path = ROOT / "engine_alpha" / "loop" / "exploit_executor_paper.py"
    if executor_path.exists():
        print(f"Checking {executor_path.name}...")
        
        # Check imports
        violations = check_imports(executor_path)
        if violations:
            errors.extend([f"{executor_path.name}: {v}" for v in violations])
        else:
            print("  ✓ No forbidden imports")
        
        # Check PAPER guard
        if check_paper_guard(executor_path):
            print("  ✓ PAPER guard present")
        else:
            warnings.append(f"{executor_path.name}: No PAPER guard found")
        
        print()
    else:
        errors.append(f"Missing: {executor_path}")
    
    # Check exploit lane runner
    runner_path = ROOT / "engine_alpha" / "loop" / "exploit_lane_runner.py"
    if runner_path.exists():
        print(f"Checking {runner_path.name}...")
        
        # Check imports
        violations = check_imports(runner_path)
        if violations:
            errors.extend([f"{runner_path.name}: {v}" for v in violations])
        else:
            print("  ✓ No forbidden imports")
        
        # Check ENABLE flag usage
        try:
            with runner_path.open("r", encoding="utf-8") as f:
                content = f.read()
            if "ENABLE_MICRO_PAPER_EXPLOIT" in content:
                print("  ✓ ENABLE flag check present")
            else:
                warnings.append(f"{runner_path.name}: ENABLE flag check not found")
        except Exception:
            pass
        
        print()
    else:
        errors.append(f"Missing: {runner_path}")
    
    # Check position sizer
    sizer_path = ROOT / "engine_alpha" / "risk" / "position_sizer.py"
    if sizer_path.exists():
        print(f"Checking {sizer_path.name}...")
        
        # Check capital mode guard
        try:
            with sizer_path.open("r", encoding="utf-8") as f:
                content = f.read()
            if 'capital_mode != "normal"' in content or 'capital_mode == "normal"' in content:
                print("  ✓ Capital mode guard present")
            else:
                warnings.append(f"{sizer_path.name}: Capital mode guard not found")
        except Exception:
            pass
        
        print()
    
    # Summary
    print("=" * 80)
    print()
    
    if errors:
        print("ERRORS:")
        for error in errors:
            print(f"  ✗ {error}")
        print()
    
    if warnings:
        print("WARNINGS:")
        for warning in warnings:
            print(f"  ⚠ {warning}")
        print()
    
    if not errors and not warnings:
        print("✓ All safety checks passed!")
        print()
        return 0
    
    if errors:
        return 1
    
    return 0


if __name__ == "__main__":
    sys.exit(main())

