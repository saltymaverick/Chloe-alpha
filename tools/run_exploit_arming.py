#!/usr/bin/env python3
"""
Run Exploit Arming Engine (Phase 5d)
-------------------------------------

CLI tool to run the exploit auto-arming engine.
"""

from __future__ import annotations

import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT))

from engine_alpha.loop.exploit_arming import run_exploit_arming


def main() -> int:
    """Run exploit arming engine."""
    state = run_exploit_arming()
    
    print("EXPLOIT AUTO-ARMING (Phase 5d)")
    print("=" * 70)
    print(f"Operator Enabled: {state.get('operator_enabled', False)}")
    print(f"Capital Mode: {state.get('capital_mode', 'unknown')}")
    print(f"Armed: {state.get('armed', False)}")
    print(f"Arm Score: {state.get('arm_score', 0.0):.3f}")
    print(f"Consecutive OK Ticks: {state.get('consecutive_ok_ticks', 0)}/{6}")
    
    if state.get("armed"):
        armed_since = state.get("armed_since", "?")
        print(f"Armed Since: {armed_since[:19] if armed_since else '?'}")
    else:
        disarm_reason = state.get("disarm_reason", "unknown")
        capital_mode = state.get("capital_mode", "unknown")
        consecutive_ok = state.get("consecutive_ok_ticks", 0)
        
        # Phase 5f: Show recovery signal if score accumulating during de_risk
        if capital_mode == "de_risk" and consecutive_ok > 0:
            print(f"Disarm Reason: {disarm_reason}")
            print(f"Recovery Signal: Score accumulating ({consecutive_ok} ticks) - will arm when capital_mode=normal")
        else:
            print(f"Disarm Reason: {disarm_reason}")
    
    eligible = state.get("eligible_symbols", [])
    
    # Get promotion mode from promotion_gate.json (not stored in arming state)
    from engine_alpha.core.paths import REPORTS
    import json
    promotion_gate_path = REPORTS / "loop" / "promotion_gate.json"
    promotion_mode = "unknown"
    if promotion_gate_path.exists():
        try:
            with promotion_gate_path.open("r", encoding="utf-8") as f:
                promotion_gate_data = json.load(f)
                promotion_mode = promotion_gate_data.get("mode", "unknown")
        except Exception:
            pass
    
    print(f"Eligible for Arming: {len(eligible)}")
    if eligible:
        print(f"  {', '.join(eligible[:10])}")
        if len(eligible) > 10:
            print(f"  ... and {len(eligible) - 10} more")
    else:
        # Add clarifying note when 0
        if promotion_mode != "EXPLOIT_ENABLED" or capital_mode != "normal":
            print("  (Note: Requires promotion_gate=EXPLOIT_ENABLED AND capital_mode=normal)")
    
    print("=" * 70)
    print(f"State written to: reports/loop/exploit_arming.json")
    
    return 0


if __name__ == "__main__":
    sys.exit(main())

